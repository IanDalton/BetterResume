import React, { createContext, useCallback, useContext, useMemo, useState, useEffect } from 'react';

export type Language = 'en' | 'es';

type Dict = Record<string, string>;

const dictionaries: Record<Language, Dict> = {
  en: {
    'app.title': 'Better Resume',
    'app.tagline': 'Made for humans, optimized for machines.',
  'app.meta.description': 'Better Resume â€“ Made for humans, optimized for machines.',
  'app.language': 'Language',
    'user.id': 'User ID',
    'format': 'Format',
  'format.latex': 'LaTeX',
  'format.word': 'Word',
    'job.description.section': 'Target Job Description',
    'job.description.placeholder': 'Paste job description here...',
    'upload.jobs': 'Upload jobs.csv',
    'generate.resume': 'Generate Resume',
    'working': 'Working...',
    'add.entry.section': 'Add Entry',
    'field.type': 'Type',
    'type.info': 'Personal Info',
    'type.education': 'Education',
    'type.job': 'Job',
    'type.non-profit': 'Non-Profit',
    'type.project': 'Project',
    'type.contract': 'Contract',
    'type.part-time': 'Part-Time',
    'field.company': 'Company',
    'field.location': 'Location',
    'field.role': 'Role / Field',
    'field.start': 'Start',
    'field.end': 'End',
    'field.description': 'Description',
    'field.extraDetails': 'Extra Details',
    'placeholder.company': 'Acme Corp',
    'placeholder.location': 'City, Country',
    'placeholder.role': 'Role',
    'placeholder.start': 'MM/YYYY',
    'placeholder.end': 'MM/YYYY or Present',
    'placeholder.description': 'Details...',
    'placeholder.extraDetails': 'When applicable...',
    'button.cancel': 'Cancel',
    'button.addEntry': 'Add Entry',
    'button.updateEntry': 'Update Entry',
  'button.clear': 'Clear All',
  'confirm.clear': 'This will remove all locally saved progress. Continue?',
    'entries.none': 'No entries yet.',
    'entry.edit': 'Edit',
    'entry.delete': 'Del',
    'present': 'Present',
    'profile.section.title': 'Profile Picture',
    'profile.upload': 'Select photo',
    'profile.uploading': 'Uploadingâ€¦',
    'profile.upload.hint': 'PNG or JPG up to 5 MB. You can crop it before saving.',
    'profile.none': 'No picture uploaded yet.',
    'profile.upload.success': 'Photo uploaded successfully.',
    'profile.upload.refreshError': 'Photo uploaded but preview could not refresh. Please try again.',
    'profile.upload.error': 'Failed to upload photo.',
    'profile.error.size': 'Image must be smaller than 5 MB.',
    'profile.toggle': 'Include profile picture when generating resumes',
    'profile.warning': 'Note: Photos are generally not recommended for US/UK applications or strict ATS systems.',
    'profile.toggle.disabled': 'Upload a photo to enable this option.',
    'profile.editing.modalTitle': 'Crop your profile photo',
    'profile.editing.subtitle': 'Drag the photo to center yourself, then zoom and choose the shape before saving.',
    'profile.editing.zoom': 'Zoom',
    'profile.editing.zoomIn': 'Zoom in',
    'profile.editing.zoomOut': 'Zoom out',
    'profile.editing.shapeLabel': 'Shape',
    'profile.editing.gestureHint': 'Drag to reposition, pinch or scroll to zoom, or use the slider below.',
    'profile.editing.reset': 'Reset position',
    'profile.editing.save': 'Save photo',
    'profile.editing.cancel': 'Cancel',
    'profile.shape.square': 'Square',
    'profile.shape.circle': 'Circle',
    'json.show': 'Show JSON output',
  'json.hide': 'Hide JSON output',
  'json.title': 'Resume JSON',
  'preview.title': 'Preview',
  'preview.pdf.unavailable': 'PDF not available',
  'download.pdf': 'Download PDF',
  'download.source': 'Edit (Download Source)',
  'download.downloading': 'Downloadingâ€¦',
  'download.preparing': 'Preparingâ€¦',
  'modal.building.title': 'Building your resumeâ€¦',
  'modal.building.subtitle': 'AI is assembling sections and formatting',
  'modal.building.hide': 'Hide (continues in background)',
  'progress.starting': 'starting',
  'donate.title': 'Enjoying BetterResume?',
  'donate.body': "You've generated 5 resumes. If this tool saved you time, consider supporting development with a small donation. It helps cover infrastructure & continued improvements.",
  'donate.cta': 'Donate',
  'donate.footer': 'We only show this once at 5 resumes. Thank you for using the app!',
  'wizard.back': 'Back',
  'wizard.next': 'Next',
  'wizard.finish': 'Finish Onboarding',
  'wizard.stage.personal': 'Personal',
  'wizard.stage.education': 'Education',
  'wizard.stage.experience': 'Experience',
  'wizard.stage.review': 'Review',
  'wizard.personal.fullName': 'Full Name',
  'wizard.personal.email': 'Email',
  'wizard.personal.phone': 'Phone',
  'wizard.personal.address': 'Location',
  'wizard.personal.websites': 'Websites / Profiles',
  'wizard.personal.label': 'Label',
  'wizard.personal.add': 'Add',
  'wizard.personal.remove': 'Remove',
  'wizard.personal.help': 'Add as many personal / professional links as you like (portfolio, GitHub, LinkedIn, etc.). Each link can have its own label.',
  'education.degree.placeholder': 'Degree / Program',
  'education.institution.placeholder': 'Institution',
  'education.location.placeholder': 'Location',
  'education.start.placeholder': 'Start',
  'education.end.placeholder': 'End / Present',
  'education.description.placeholder': 'Description / Achievements',
  'education.add': 'Add Education',
  'experience.role.placeholder': 'Role / Title',
  'experience.company.placeholder': 'Company / Org',
  'experience.location.placeholder': 'Location',
  'experience.start.placeholder': 'Start',
  'experience.end.placeholder': 'End / Present',
  'experience.description.placeholder': 'Description / Impact',
  'experience.add': 'Add Experience',
  'review.title': 'Review',
  'review.body': "Quick summary of what you've added. You can finish to access full dashboard and make further edits.",
  'auth.welcome': 'Welcome',
  'auth.tagline': 'Create an account to save your resumes across devices. Or continue as a guest (local only).',
  'auth.email': 'Email',
  'auth.password': 'Password',
  'auth.needAccount': 'Need an account? Sign up',
  'auth.haveAccount': 'Have an account? Sign in',
  'auth.signIn': 'Sign In',
  'auth.createAccount': 'Create Account',
  'auth.or': 'or',
  'auth.continueGoogle': 'Continue with Google',
  'auth.working': 'Working...',
  'auth.guest.notice': 'Guest sessions use a random ID stored only in this browser. Clearing site data or switching devices will lose your resumes.',
  'auth.logout': 'Logout',
  'auth.guest': 'Guest',
  'auth.error.generic': 'Auth failed',
  'auth.error.google': 'Google sign-in failed',
  'auth.error.guest': 'Guest sign-in failed',
    'jobs.none': 'No jobs added yet.',
    'jobs.title': 'Title',
    'jobs.company': 'Company',
    'jobs.start': 'Start',
    'jobs.end': 'End',
    'jobs.description': 'Description',
    'jobs.actions': 'Actions',
    'jobs.remove': 'Remove',
    'lang.english': 'English',
    'lang.spanish': 'Spanish',
    'field.personal.name': 'name',
    'field.personal.email': 'email',
    'field.personal.phone': 'phone',
    'field.personal.website': 'website',
    'field.personal.address': 'address'
  ,
  // Guide modal
  'guide.title': 'Welcome to Better resume',
  'guide.intro': 'Quick guide to tailor your resume for a specific role:',
  'guide.step1': 'Paste the target job description into the Job Description box (you can copy it directly from a LinkedIn job post).',
  'guide.step2': 'Add your details and experience in the entry section above. Keep bullets actionâ€‘oriented and measurable.',
  'guide.step3': 'Choose your preferred format (Word or LaTeX), then click Generate Resume.',
  'guide.step4': 'Review the preview, then download the PDF and/or source.',
  'guide.tip': 'Tip: For best results, match keywords from the job post (skills, tools, responsibilities) in your entries.',
  'guide.gotIt': 'Got it',
  'guide.button.title': 'Quick guide',
  // Footer
  'footer.brandline': 'Better resume â€” a tool made by Ian Dalton',
  'footer.gotJob': 'Got the job? Consider donating to keep the tool free!',
  // Donation toast
  'donate.toast.title': 'Help keep it free',
  'donate.toast.body': 'Traffic grew a lot. A small donation (~$5 USD, less than a big mac) helps keep the servers running and this tool free.',
  'donate.toast.cta': 'Donate',
  'donate.toast.dismiss': 'Not now',
  // Stripe donation
  'donate.stripe.title': 'Help Keep BetterResume Free',
  'donate.stripe.body.international': 'If this tool saved you time, consider supporting development with a small donation. Payments are processed securely via Stripe.',
  'donate.stripe.body.argentina': 'Si te resultÃ³ Ãºtil, considera hacer una pequeÃ±a donaciÃ³n para mantener el proyecto en funcionamiento. Pagos seguros con Stripe.',
  'donate.stripe.cta': 'Donate via Stripe',
  'donate.error': 'Failed to process donation. Please try again.',
  // Donate page
  'donate.changeAmount': 'Donate again',
  'donate.back': 'Back to Home',
  'donate.job.title': 'Congratulations!',
  'donate.job.subtitle': 'Celebrate your new role by keeping this tool free for the next job seeker.',
  'donate.job.button': 'Donate $25 to celebrate',
  'donate.support.title': 'Support Better Resume',
  'donate.support.subtitle': 'Help us keep this tool free for everyone.',
  'donate.amount.label': 'Amount (USD)',
  'donate.processing': 'Processing...',
  'donate.button': 'Donate $',
  'donate.reason.label': 'What brings you here?',
  'donate.reason.support': 'Just want to support',
  'donate.reason.job': 'I got a job! ðŸŽ‰',
  'donate.later': 'Maybe later',
  'donate.complete.title': 'Thank you for helping keep this tool free!',
  'donate.error.amount': 'Please enter a valid amount',
  'donate.error.session': 'Failed to create donation session',
  'donate.error.secret': 'No client secret returned',
  'donate.error.process': 'Something went wrong. Please try again.',
  // Thank You page
  'thankyou.title': 'Thank You!',
  'thankyou.message': 'Your donation helps keep BetterResume free and running for everyone. We really appreciate your support!',
  'thankyou.back': 'Back to Resume Builder',
  // Home page
  'geo.unknown': 'Unknown',
  'upload.unchanged': 'Jobs unchanged; ingestion skipped',
  'upload.success.rows': 'Jobs uploaded',
  'upload.success': 'Jobs uploaded',
  'upload.failed': 'Upload failed',
  'generate.error.personal': 'Please complete your personal info (name and email) before generating.',
  'generate.error.experience': 'Please add at least one experience entry before generating.',
  'generate.error.failed': 'Generation failed',
  'download.error.notReady': 'File not ready',
  'download.error.failed': 'Download failed',
  'validation.personal': 'Please complete your personal info (name and email).',
  'validation.experience': 'Please add at least one experience entry.'
  },
  es: {
    'app.title': 'Better Resume',
    'app.tagline': 'Hecho para humanos, optimizado para mÃ¡quinas.',
  'app.meta.description': 'Better Resume â€“ Hecho para humanos, optimizado para mÃ¡quinas.',
  'app.language': 'Idioma',
    'user.id': 'ID de Usuario',
    'format': 'Formato',
  'format.latex': 'LaTeX',
  'format.word': 'Word',
    'job.description.section': 'DescripciÃ³n del Puesto Objetivo',
    'job.description.placeholder': 'Pega aquÃ­ la descripciÃ³n del puesto...',
    'upload.jobs': 'Subir jobs.csv',
    'generate.resume': 'Generar CurrÃ­culum',
    'working': 'Trabajando...',
    'add.entry.section': 'Agregar Entrada',
    'field.type': 'Tipo',
    'type.info': 'InformaciÃ³n Personal',
    'type.education': 'EducaciÃ³n',
    'type.job': 'Trabajo',
    'type.non-profit': 'ONG',
    'type.project': 'Proyecto',
    'type.contract': 'Contrato',
    'type.part-time': 'Medio Tiempo',
    'field.company': 'Empresa',
    'field.location': 'UbicaciÃ³n',
    'field.role': 'Cargo / Campo',
    'field.start': 'Inicio',
    'field.end': 'Fin',
    'field.description': 'DescripciÃ³n',
    'field.extraDetails': 'Detalles Extra',
    'placeholder.company': 'Ej: Acme Corp',
    'placeholder.location': 'Ciudad, PaÃ­s',
    'placeholder.role': 'Cargo',
    'placeholder.start': 'MM/AAAA',
    'placeholder.end': 'MM/AAAA o Actual',
    'placeholder.description': 'Detalles...',
    'placeholder.extraDetails': 'Cuando corresponda...',
    'button.cancel': 'Cancelar',
    'button.addEntry': 'Agregar Entrada',
    'button.updateEntry': 'Actualizar Entrada',
  'button.clear': 'Borrar Todo',
  'confirm.clear': 'Esto eliminarÃ¡ el progreso local guardado. Â¿Continuar?',
    'entries.none': 'Sin entradas todavÃ­a.',
    'entry.edit': 'Editar',
    'entry.delete': 'Borrar',
    'present': 'Actual',
    'profile.section.title': 'Foto de perfil',
    'profile.upload': 'Elegir foto',
    'profile.uploading': 'Subiendoâ€¦',
    'profile.upload.hint': 'PNG o JPG de hasta 5 MB. PodrÃ¡s recortarla antes de guardar.',
    'profile.none': 'AÃºn no subiste una foto.',
    'profile.upload.success': 'Foto cargada correctamente.',
    'profile.upload.refreshError': 'La foto se cargÃ³ pero no se pudo actualizar la vista previa. Vuelve a intentarlo.',
    'profile.upload.error': 'No se pudo subir la foto.',
    'profile.error.size': 'La imagen debe pesar menos de 5 MB.',
    'profile.toggle': 'Incluir la foto al generar el CV',
    'profile.warning': 'Nota: Las fotos generalmente no se recomiendan para solicitudes en EE. UU./Reino Unido o sistemas ATS estrictos.',
    'profile.toggle.disabled': 'Sube una foto para habilitar esta opciÃ³n.',
    'profile.editing.modalTitle': 'Recorta tu foto de perfil',
    'profile.editing.subtitle': 'Arrastra la foto para centrarte, ajusta el zoom y elige la forma antes de guardar.',
    'profile.editing.zoom': 'Zoom',
    'profile.editing.zoomIn': 'Acercar',
    'profile.editing.zoomOut': 'Alejar',
    'profile.editing.shapeLabel': 'Forma',
    'profile.editing.gestureHint': 'Arrastra para recolocar, pellizca o usa la rueda para hacer zoom, o ajusta el control deslizante.',
    'profile.editing.reset': 'Restablecer posiciÃ³n',
    'profile.editing.save': 'Guardar foto',
    'profile.editing.cancel': 'Cancelar',
    'profile.shape.square': 'Cuadrada',
    'profile.shape.circle': 'Circular',
  'json.show': 'Mostrar salida JSON',
  'json.hide': 'Ocultar salida JSON',
  'json.title': 'JSON del CurrÃ­culum',
  'preview.title': 'Vista previa',
  'preview.pdf.unavailable': 'PDF no disponible',
  'download.pdf': 'Descargar PDF',
  'download.source': 'Editar (Descargar fuente)',
  'download.downloading': 'Descargandoâ€¦',
  'download.preparing': 'Preparandoâ€¦',
  'modal.building.title': 'Construyendo tu currÃ­culumâ€¦',
  'modal.building.subtitle': 'La IA estÃ¡ ensamblando secciones y formato',
  'modal.building.hide': 'Ocultar (continÃºa en segundo plano)',
  'progress.starting': 'iniciando',
  'donate.title': 'Â¿Disfrutando BetterResume?',
  'donate.body': 'Has generado 5 currÃ­culums. Si esta herramienta te ahorrÃ³ tiempo, considera apoyar el desarrollo con una pequeÃ±a donaciÃ³n. Ayuda a cubrir infraestructura y mejoras continuas.',
  'donate.cta': 'Donar',
  'donate.footer': 'Mostramos esto solo una vez al llegar a 5 currÃ­culums. Â¡Gracias por usar la aplicaciÃ³n!',
  'wizard.back': 'AtrÃ¡s',
  'wizard.next': 'Siguiente',
  'wizard.finish': 'Finalizar',
  'wizard.stage.personal': 'Personal',
  'wizard.stage.education': 'EducaciÃ³n',
  'wizard.stage.experience': 'Experiencia',
  'wizard.stage.review': 'RevisiÃ³n',
  'wizard.personal.fullName': 'Nombre completo',
  'wizard.personal.email': 'Correo',
  'wizard.personal.phone': 'TelÃ©fono',
  'wizard.personal.address': 'UbicaciÃ³n',
  'wizard.personal.websites': 'Sitios / Perfiles',
  'wizard.personal.label': 'Etiqueta',
  'wizard.personal.add': 'Agregar',
  'wizard.personal.remove': 'Quitar',
  'wizard.personal.help': 'Agrega los enlaces personales/profesionales que quieras (portafolio, GitHub, LinkedIn, etc.). Cada enlace puede tener su propia etiqueta.',
  'education.degree.placeholder': 'TÃ­tulo / Programa',
  'education.institution.placeholder': 'InstituciÃ³n',
  'education.location.placeholder': 'UbicaciÃ³n',
  'education.start.placeholder': 'Inicio',
  'education.end.placeholder': 'Fin / Actual',
  'education.description.placeholder': 'DescripciÃ³n / Logros',
  'education.add': 'Agregar EducaciÃ³n',
  'experience.role.placeholder': 'Rol / TÃ­tulo',
  'experience.company.placeholder': 'Empresa / Org',
  'experience.location.placeholder': 'UbicaciÃ³n',
  'experience.start.placeholder': 'Inicio',
  'experience.end.placeholder': 'Fin / Actual',
  'experience.description.placeholder': 'DescripciÃ³n / Impacto',
  'experience.add': 'Agregar Experiencia',
  'review.title': 'RevisiÃ³n',
  'review.body': 'Resumen rÃ¡pido de lo que aÃ±adiste. Puedes finalizar para acceder al panel y seguir editando.',
  'auth.welcome': 'Bienvenido',
  'auth.tagline': 'Crea una cuenta para guardar tus currÃ­culums entre dispositivos. O continÃºa como invitado (solo local).',
  'auth.email': 'Correo',
  'auth.password': 'ContraseÃ±a',
  'auth.needAccount': 'Â¿Necesitas una cuenta? RegÃ­strate',
  'auth.haveAccount': 'Â¿Tienes una cuenta? Inicia sesiÃ³n',
  'auth.signIn': 'Iniciar SesiÃ³n',
  'auth.createAccount': 'Crear Cuenta',
  'auth.or': 'o',
  'auth.continueGoogle': 'Continuar con Google',
  'auth.working': 'Trabajando...',
  'auth.guest.notice': 'Las sesiones de invitado usan un ID aleatorio solo en este navegador. Limpiar datos o cambiar de dispositivo perderÃ¡ tus currÃ­culums.',
  'auth.logout': 'Cerrar SesiÃ³n',
  'auth.guest': 'Invitado',
  'auth.error.generic': 'Fallo de autenticaciÃ³n',
  'auth.error.google': 'Fallo con Google',
  'auth.error.guest': 'Fallo al entrar como invitado',
    'jobs.none': 'AÃºn no se agregaron trabajos.',
    'jobs.title': 'TÃ­tulo',
    'jobs.company': 'Empresa',
    'jobs.start': 'Inicio',
    'jobs.end': 'Fin',
    'jobs.description': 'DescripciÃ³n',
    'jobs.actions': 'Acciones',
    'jobs.remove': 'Quitar',
    'lang.english': 'InglÃ©s',
    'lang.spanish': 'EspaÃ±ol',
    'field.personal.name': 'nombre',
    'field.personal.email': 'correo',
    'field.personal.phone': 'telÃ©fono',
    'field.personal.website': 'sitio web',
    'field.personal.address': 'direcciÃ³n'
  ,
  // Guide modal
  'guide.title': 'Bienvenido a Better resume',
  'guide.intro': 'GuÃ­a rÃ¡pida para adaptar tu currÃ­culum a un puesto especÃ­fico:',
  'guide.step1': 'Pega la descripciÃ³n del puesto objetivo en el cuadro de DescripciÃ³n del Puesto (puedes copiarla directamente de una oferta en LinkedIn).',
  'guide.step2': 'AÃ±ade tus datos y experiencia en la secciÃ³n de entradas de arriba. MantÃ©n los puntos orientados a la acciÃ³n y medibles.',
  'guide.step3': 'Elige tu formato preferido (Word o LaTeX) y haz clic en Generar CurrÃ­culum.',
  'guide.step4': 'Revisa la vista previa y luego descarga el PDF y/o la fuente.',
  'guide.tip': 'Consejo: Para mejores resultados, incluye palabras clave de la oferta (habilidades, herramientas, responsabilidades) en tus entradas.',
  'guide.gotIt': 'Entendido',
  'guide.button.title': 'GuÃ­a rÃ¡pida',
  // Footer
  'footer.brandline': 'Better resume â€” una herramienta creada por Ian Dalton',
  'footer.gotJob': 'Â¿Conseguiste el trabajo? Â¡Considera donar para mantener la herramienta gratis!',
  // Donation toast
  'donate.toast.title': 'AyÃºdanos a mantenerlo gratis',
  'donate.toast.body': 'El trÃ¡fico creciÃ³ mucho. Una pequeÃ±a donaciÃ³n (~$5.000 ARS, menos que una hamburguesa) ayuda a mantener el servidor y esta herramienta gratis.',
  'donate.toast.cta': 'Donar',
  'donate.toast.dismiss': 'Ahora no',
  // Stripe donation
  'donate.stripe.title': 'AyÃºdanos a mantener BetterResume gratis',
  'donate.stripe.body.international': 'Si te resultÃ³ Ãºtil, considera apoyar el desarrollo con una pequeÃ±a donaciÃ³n. Pagos seguros a travÃ©s de Stripe.',
  'donate.stripe.body.argentina': 'Si te resultÃ³ Ãºtil, considera hacer una pequeÃ±a donaciÃ³n para mantener el proyecto en funcionamiento. Pagos seguros con Stripe.',
  'donate.stripe.cta': 'Donar con Stripe',
  'donate.error': 'FallÃ³ al procesar la donaciÃ³n. Por favor, intenta de nuevo.',
  // Donate page
  'donate.error.amount': 'Por favor ingresa un monto vÃ¡lido',
  'donate.error.session': 'Fallo al crear la sesiÃ³n',
  'donate.error.secret': 'No se recibiÃ³ el secreto del cliente',
  'donate.error.process': 'Fallo al procesar la donaciÃ³n. Por favor intenta de nuevo.',
  'donate.job.title': 'Â¡Felicitaciones!',
  'donate.job.subtitle': 'Celebra tu nuevo puesto ayudando a mantener esta herramienta gratuita para el prÃ³ximo candidato.',
  'donate.job.button': 'Donar $25 para celebrar',
  'donate.complete.title': 'Â¡Gracias por ayudar a mantener esta herramienta gratuita!',
  'donate.changeAmount': 'Donar de nuevo',
  'donate.back': 'Volver al Inicio',
  'donate.support.title': 'Apoya a Better Resume',
  'donate.support.subtitle': 'AyÃºdanos a mantener esta herramienta gratuita para todos.',
  'donate.amount.label': 'Monto (USD)',
  'donate.processing': 'Procesando...',
  'donate.button': 'Donar $',
  'donate.reason.label': 'Â¿QuÃ© te trae por aquÃ­?',
  'donate.reason.support': 'Solo quiero apoyar',
  'donate.reason.job': 'Â¡ConseguÃ­ trabajo! ðŸŽ‰',
  'donate.later': 'QuizÃ¡s mÃ¡s tarde',
  // Thank You page
  'thankyou.title': 'Â¡Gracias!',
  'thankyou.message': 'Tu donaciÃ³n ayuda a mantener BetterResume gratis y funcionando para todos. Â¡Realmente apreciamos tu apoyo!',
  'thankyou.back': 'Volver al Constructor de CV',
  // Home page
  'geo.unknown': 'Desconocido',
  'upload.unchanged': 'Trabajos sin cambios; ingesta omitida',
  'upload.success.rows': 'Trabajos subidos',
  'upload.success': 'Trabajos subidos',
  'upload.failed': 'Fallo en la subida',
  'generate.error.personal': 'Por favor completa tu informaciÃ³n personal (nombre y correo) antes de generar.',
  'generate.error.experience': 'Por favor agrega al menos una experiencia antes de generar.',
  'generate.error.failed': 'Fallo en la generaciÃ³n',
  'download.error.notReady': 'Archivo no listo',
  'download.error.failed': 'Fallo en la descarga',
  'validation.personal': 'Por favor completa tu informaciÃ³n personal (nombre y correo).',
  'validation.experience': 'Por favor agrega al menos una experiencia.'
  }
};

interface I18nContextValue {
  lang: Language;
  setLang: (l: Language) => void;
  t: (key: string) => string;
}

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

function detectInitialLang(): Language {
  try {
    const stored = localStorage.getItem('lang') as Language | null;
    if (stored && (stored in dictionaries)) return stored;
    const supported = Object.keys(dictionaries);
    if (typeof navigator !== 'undefined') {
      const nav: any = navigator;
      const candidates: string[] = [];
      if (nav.languages) candidates.push(...nav.languages);
      if (navigator.language) candidates.push(navigator.language);
      for (const raw of candidates) {
        if (!raw) continue;
        const base = raw.toLowerCase().split('-')[0];
        const match = supported.find(s => s === base);
        if (match) return match as Language;
      }
    }
  } catch {/* ignore */}
  return 'en'; // default fallback
}

export const I18nProvider: React.FC<{children: React.ReactNode}> = ({ children }) => {
  const [lang, setLangState] = useState<Language>(() => detectInitialLang());

  const setLang = useCallback((l: Language) => {
    setLangState(l);
    localStorage.setItem('lang', l);
  }, []);

  const t = useCallback((key: string) => {
    const dict = dictionaries[lang];
    return dict[key] || dictionaries.en[key] || key;
  }, [lang]);

  useEffect(() => {
    try { document.documentElement.lang = lang; } catch {/* ignore */}
  }, [lang]);

  // If user hasn't explicitly chosen (no stored lang), respond to system/browser language changes.
  useEffect(() => {
    if (localStorage.getItem('lang')) return; // respect explicit choice
    const handler = () => {
      const detected = detectInitialLang();
      setLangState(detected);
    };
    window.addEventListener('languagechange', handler);
    return () => window.removeEventListener('languagechange', handler);
  }, []);

  const value = useMemo(() => ({ lang, setLang, t }), [lang, setLang, t]);
  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
};

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error('useI18n must be used within I18nProvider');
  return ctx;
}

export const availableLanguages: { code: Language; labelKey: string }[] = [
  { code: 'en', labelKey: 'lang.english' },
  { code: 'es', labelKey: 'lang.spanish' }
];
